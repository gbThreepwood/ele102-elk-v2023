<!DOCTYPE html>




<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Basics of digital filters &mdash; ELE102 Microcontroller course v1.1.0 documentation</title>
    <meta name="description" content="">
    <meta name="author" content="">

    

<link rel="stylesheet" href="../../_static/css/basicstrap-base.css" type="text/css" />
<link rel="stylesheet" id="current-theme" href="../../_static/css/bootstrap3/bootstrap.min.css" type="text/css" />
<link rel="stylesheet" id="current-adjust-theme" type="text/css" />

<link rel="stylesheet" href="../../_static/css/font-awesome.min.css">

<style type="text/css">
  body {
    padding-top: 60px;
    padding-bottom: 40px;
  }
</style>

<link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
<link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
<link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
<link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
<link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
    
<script type="text/javascript">
  var DOCUMENTATION_OPTIONS = {
            URL_ROOT:    '../../',
            VERSION:     'v1.1.0',
            COLLAPSE_INDEX: false,
            FILE_SUFFIX: '.html',
            HAS_SOURCE:  true
  };
</script>
    <script type="text/javascript" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/js/jquery.min.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/js/bootstrap3.min.js"></script>
<script type="text/javascript" src="../../_static/js/jquery.cookie.min.js"></script>
<script type="text/javascript" src="../../_static/js/basicstrap.js"></script>
<script type="text/javascript">
</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="top" title="ELE102 Microcontroller course v1.1.0 documentation" href="../../index.html" />
    <link rel="next" title="Floating point number representation" href="floating_point_numbers.html" />
    <link rel="prev" title="Assembly programming" href="assembly_programming.html" /> 
  </head>
  <body role="document">
    <div id="navbar-top" class="navbar navbar-fixed-top navbar-default" role="navigation" aria-label="top navigation">
      <div class="container-fluid">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../../index.html">ELE102 Microcontroller course v1.1.0 documentation</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav navbar-right">
              <li class="dropdown visible-xs">
                <a role="button" id="localToc" data-toggle="dropdown" data-target="#" href="#">Table Of Contents <b class="caret"></b></a>
                <ul class="dropdown-menu localtoc sp-localtoc" role="menu" aria-labelledby="localToc">
                <ul>
<li><a class="reference internal" href="#">Basics of digital filters</a><ul>
<li><a class="reference internal" href="#efficiency">Efficiency</a></li>
<li><a class="reference internal" href="#moving-average">Moving average</a></li>
<li><a class="reference internal" href="#finite-impulse-response-fir-filter">Finite impulse response (FIR) filter</a></li>
<li><a class="reference internal" href="#infinite-impulse-response-iir-filter">Infinite impulse response (IIR) filter</a><ul>
<li><a class="reference internal" href="#lowpass-filter-floating-point-version">Lowpass filter (Floating point version)</a></li>
<li><a class="reference internal" href="#notch-filter">Notch filter</a></li>
</ul>
</li>
<li><a class="reference internal" href="#cascaded-integrator-comb-cic">Cascaded integrator comb (CIC)</a><ul>
<li><a class="reference internal" href="#id1">Moving average</a></li>
<li><a class="reference internal" href="#decimation-of-a-pdm-signal-from-a-digital-mems-microphone">Decimation of a PDM signal from a digital MEMS microphone</a></li>
</ul>
</li>
</ul>
</li>
</ul>

                </ul>
              </li>

            
              <li><a href="assembly_programming.html" title="Assembly programming" accesskey="P">previous </a></li>
              <li><a href="floating_point_numbers.html" title="Floating point number representation" accesskey="N">next </a></li>
              <li><a href="../../genindex.html" title="General Index" accesskey="I">index </a></li>
            

            <li class="visible-xs">
                <form class="search form-search form-inline navbar-form navbar-right sp-searchbox" action="../../search.html" method="get">
                  <div class="input-append input-group">
                    <input type="text" class="search-query form-control" name="q" placeholder="Search...">
                    <span class="input-group-btn">
                    <input type="submit" class="btn" value="Go" />
                    </span>
                  </div>
                  <input type="hidden" name="check_keywords" value="yes" />
                  <input type="hidden" name="area" value="default" />
                </form>
            </li>

            

          </ul>

        </div>
      </div>
    </div>
    

    <!-- container -->
    <div class="container-fluid">

      <!-- row -->
      <div class="row">
         
<div class="col-md-3 hidden-xs" id="sidebar-wrapper">
  <div class="sidebar hidden-xs" role="navigation" aria-label="main navigation">
<h3><a href="../../index.html">Table of Contents</a></h3>
<p class="caption" role="heading"><span class="caption-text">Lessons:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Lessons/L0_Introduction_elk.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons/software_hardware_preparations.html">Software and hardware preparations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons/L1a_UC_intro.html">Lesson 1a: What is a Microcontroller</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons/L1b_Arduino_intro.html">Lesson 1b: Introduction to Arduino</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons/L2_digital_io.html">Lesson 2: Digital I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons/L3_digital_io_and_timing.html">Lesson 3: Use of digital I/O and timing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons/L4_dac_pwm.html">Lesson 4: Analog output (PWM)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons/L5_adc.html">Lesson 5: Analog to digital conversion (ADC)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons/L6_serial_io.html">Lesson 6: Serial I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons/L7_timer_interrupt.html">Lesson 7: Timers and interrupts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons/L8_LC_display.html">Lesson 8: LC-Display</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons/L9_memory_and_architecture.html">Lesson 9: Memory and MCU architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons/L10_motor_drive.html">Lesson 10: Motor drive</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons/L12_communication.html">Lesson 11: Communication Protocols</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Additional material:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L1_additional.html">Additional material lesson 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L2_additional.html">Additional material lesson 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L3_additional.html">Additional material lesson 3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L4_additional.html">Additional material lesson 4</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L5_additional.html">Additional material lesson 5</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L6_additional.html">Additional material lesson 6</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L7_additional.html">Additional material lesson 7</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L8_additional.html">Additional material lesson 8</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L9_additional.html">Additional material lesson 9</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L10_additional.html">Additional material lesson 10</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L11_additional.html">Additional material lesson 11</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L12_additional.html">Additional material lesson 12</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L13_additional.html">Additional material lesson 13</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Projects:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="Additionals.html">Binary counter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/ir_communication.html">Infrared remote</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/adaptive_line_enhancer.html">Adaptive line enhancer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/audio_processing.html">Audio processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/RC_car.html">Cool Project: RC Car (Bluetooth or Joystick)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/Robotarm.html">Cool Project: Simple Robot Arm (Bluetooth or Joystick)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/dc_motor_control.html">DC motor control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/digital_piano.html">Digital piano</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/digital_synth.html">Digital synth</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/dtmf_generator.html">DTMF generator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/frequency_estimator.html">Frequency estimator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/induction_motor_control.html">Induction motor control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/lorawan.html">LoRaWan</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/phase_displacement.html">Phase displacement</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/phase_locked_loop.html">Phase locked loop (PLL)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/phasor_estimation.html">Phasor estimation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/radio_transmitter.html">Radio transmitter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/stepper_motor_control.html">Stepper motor control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/synchroscope.html">Synchroscope</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/thyristor_controller.html">Thyristor controller</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Appendices:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="low_power_operation.html">Low power operation</a></li>
<li class="toctree-l1"><a class="reference internal" href="stacks_queues_lists.html">Stacks, Queues, Lists</a></li>
<li class="toctree-l1"><a class="reference internal" href="assembly_programming.html">Assembly programming</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Digital filters</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#efficiency">Efficiency</a></li>
<li class="toctree-l2"><a class="reference internal" href="#moving-average">Moving average</a></li>
<li class="toctree-l2"><a class="reference internal" href="#finite-impulse-response-fir-filter">Finite impulse response (FIR) filter</a></li>
<li class="toctree-l2"><a class="reference internal" href="#infinite-impulse-response-iir-filter">Infinite impulse response (IIR) filter</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#lowpass-filter-floating-point-version">Lowpass filter (Floating point version)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#notch-filter">Notch filter</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#cascaded-integrator-comb-cic">Cascaded integrator comb (CIC)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">Moving average</a></li>
<li class="toctree-l3"><a class="reference internal" href="#decimation-of-a-pdm-signal-from-a-digital-mems-microphone">Decimation of a PDM signal from a digital MEMS microphone</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="floating_point_numbers.html">Floating point numbers</a></li>
<li class="toctree-l1"><a class="reference internal" href="kalman_filter.html">Kalman filter</a></li>
<li class="toctree-l1"><a class="reference internal" href="the_build_process.html">The build process</a></li>
<li class="toctree-l1"><a class="reference internal" href="direct_register_manipulations.html">Direct register manipulation</a></li>
</ul>

<div id="searchbox" role="search">
  <h3>Quick search</h3>
  <form class="search form-inline" action="../../search.html" method="get">
      <div class="input-append input-group">
        <input type="text" class="search-query form-control" name="q" placeholder="Search...">
        <span class="input-group-btn">
        <input type="submit" class="btn" value="Go" />
        </span>
      </div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="assembly_programming.html"
                          title="previous chapter">Assembly programming</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="floating_point_numbers.html"
                          title="next chapter">Floating point number representation</a></p>
  </div>
  </div>
</div> 
        

        <div class="col-md-9" id="content-wrapper">
          <div class="document" role="main">
            <div class="documentwrapper">
              <div class="bodywrapper">
                <div class="body">
                  
  <section id="basics-of-digital-filters">
<span id="digital-filters"></span><h1>Basics of digital filters<a class="headerlink" href="#basics-of-digital-filters" title="Permalink to this headline">¶</a></h1>
<section id="efficiency">
<h2>Efficiency<a class="headerlink" href="#efficiency" title="Permalink to this headline">¶</a></h2>
<p>Floating point operations on the Atmega328p are generally very slow. Some mathematical operations, such as division, or trigonometric functions can take hundreds of clock cycles to complete. Thus floating point is is not a viable option for a digital filter running in real time, unless the frequencies of interest are very low. In order to overcome this issue one may employ fixed point numbers instead of floating point. Trigonometric functions, if needed, could be performed by means of lookup tables.</p>
<p>There are other microcontrollers which are better suited for digital signal processing, but with the aforementioned considerations even the Atmega328p can be used for many applications.</p>
</section>
<section id="moving-average">
<h2>Moving average<a class="headerlink" href="#moving-average" title="Permalink to this headline">¶</a></h2>
</section>
<section id="finite-impulse-response-fir-filter">
<h2>Finite impulse response (FIR) filter<a class="headerlink" href="#finite-impulse-response-fir-filter" title="Permalink to this headline">¶</a></h2>
</section>
<section id="infinite-impulse-response-iir-filter">
<h2>Infinite impulse response (IIR) filter<a class="headerlink" href="#infinite-impulse-response-iir-filter" title="Permalink to this headline">¶</a></h2>
<p>A infinite impulse response (IIR) filter as the name implies, has a theoretically infinite impulse response. This is due to feedback from the output back in to the input of the filter. In practice the impulse response will die off after a while due to limitations to the smallest value that can be stored in the memory of the computer performing the filtering.</p>
<p>IIR filters are more complicated to analyze and design than FIR filters, but they are a lot more efficient. This means that for a given microcontroller or other signal processor, you will be able to achieve a much higher sample rate.</p>
<section id="lowpass-filter-floating-point-version">
<h3>Lowpass filter (Floating point version)<a class="headerlink" href="#lowpass-filter-floating-point-version" title="Permalink to this headline">¶</a></h3>
<p>As mentioned previously floating point operations are slow on the Atmega328p. Still they are easy to implement, and fast enough for a small filter with sampling rate of 1 kHz. The following filter is designed for low pass filtering of a 50 Hz sine wave, in order to remove any higher frequency components.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="cm">/**</span>
<span class="linenos">  2</span><span class="cm"> * @file main.cpp</span>
<span class="linenos">  3</span><span class="cm"> * @author Eirik Haustveit (ehau@hvl.no)</span>
<span class="linenos">  4</span><span class="cm"> * @brief </span>
<span class="linenos">  5</span><span class="cm"> * @version 0.1</span>
<span class="linenos">  6</span><span class="cm"> * @date 2022-02-06</span>
<span class="linenos">  7</span><span class="cm"> * </span>
<span class="linenos">  8</span><span class="cm"> * @copyright Copyright (c) 2022</span>
<span class="linenos">  9</span><span class="cm"> * </span>
<span class="linenos"> 10</span><span class="cm"> */</span>
<span class="linenos"> 11</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Arduino.h&gt;</span>
<span class="linenos"> 12</span>
<span class="linenos"> 13</span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">signal_pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A0</span><span class="p">;</span>
<span class="linenos"> 14</span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">interval_pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
<span class="linenos"> 15</span>
<span class="linenos"> 16</span><span class="kt">void</span><span class="w"> </span><span class="nf">setup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 17</span><span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="n">signal_pin</span><span class="p">,</span><span class="w"> </span><span class="n">INPUT</span><span class="p">);</span>
<span class="linenos"> 18</span><span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="n">interval_pin</span><span class="p">,</span><span class="w"> </span><span class="n">OUTPUT</span><span class="p">);</span>
<span class="linenos"> 19</span>
<span class="linenos"> 20</span><span class="w">  </span><span class="c1">// The baudrate must be sufficient to transmit 10 bytes in significantly less than 1 millisecond.</span>
<span class="linenos"> 21</span><span class="w">  </span><span class="c1">// One iteration of the float iir filter with third order runs at approximately 200 us, which leaves 800 us</span>
<span class="linenos"> 22</span><span class="w">  </span><span class="c1">// for everything else.</span>
<span class="linenos"> 23</span><span class="w">  </span><span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">230400</span><span class="p">);</span>
<span class="linenos"> 24</span><span class="p">}</span>
<span class="linenos"> 25</span>
<span class="linenos"> 26</span><span class="c1">//float a[] = {0, -2.153, 1.705, -0.4789};</span>
<span class="linenos"> 27</span><span class="c1">//float b[] = {0.009172, 0.02752, 0.02752, 0.009172};</span>
<span class="linenos"> 28</span>
<span class="linenos"> 29</span><span class="kt">float</span><span class="w"> </span><span class="n">a</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">-2.276</span><span class="p">,</span><span class="w"> </span><span class="mf">2.201</span><span class="p">,</span><span class="w"> </span><span class="mf">-1.14</span><span class="p">,</span><span class="w"> </span><span class="mf">0.2946</span><span class="p">};</span>
<span class="linenos"> 30</span><span class="kt">float</span><span class="w"> </span><span class="n">b</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mf">0.53</span><span class="p">,</span><span class="w"> </span><span class="mf">-1.708</span><span class="p">,</span><span class="w"> </span><span class="mf">2.436</span><span class="p">,</span><span class="w"> </span><span class="mf">-1.708</span><span class="p">,</span><span class="w"> </span><span class="mf">0.53</span><span class="p">};</span>
<span class="linenos"> 31</span>
<span class="linenos"> 32</span><span class="kt">float</span><span class="w"> </span><span class="n">v</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
<span class="linenos"> 33</span>
<span class="linenos"> 34</span><span class="kt">float</span><span class="w"> </span><span class="nf">iir_filter_run</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">x</span><span class="p">){</span>
<span class="linenos"> 35</span><span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 36</span>
<span class="linenos"> 37</span>
<span class="linenos"> 38</span><span class="w">  </span><span class="n">v</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="linenos"> 39</span><span class="w">  </span><span class="n">v</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="linenos"> 40</span><span class="w">  </span><span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="linenos"> 41</span><span class="w">  </span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="linenos"> 42</span><span class="w">  </span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">v</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">v</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">a</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<span class="linenos"> 43</span>
<span class="linenos"> 44</span><span class="w">  </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">v</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">v</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<span class="linenos"> 45</span>
<span class="linenos"> 46</span><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
<span class="linenos"> 47</span><span class="p">}</span>
<span class="linenos"> 48</span>
<span class="linenos"> 49</span><span class="k">const</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">sample_interval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="c1">// Sampling rate at 1 kHz</span>
<span class="linenos"> 50</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">prev_millis_timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 51</span><span class="kt">char</span><span class="w"> </span><span class="n">buffer</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
<span class="linenos"> 52</span>
<span class="linenos"> 53</span><span class="kt">void</span><span class="w"> </span><span class="nf">loop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 54</span>
<span class="linenos"> 55</span><span class="w">  </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">millis_timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">millis</span><span class="p">();</span>
<span class="linenos"> 56</span>
<span class="linenos"> 57</span><span class="w">  </span><span class="k">if</span><span class="p">((</span><span class="kt">uint32_t</span><span class="p">)(</span><span class="n">millis_timestamp</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">prev_millis_timestamp</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">sample_interval</span><span class="p">){</span>
<span class="linenos"> 58</span>
<span class="linenos"> 59</span>
<span class="linenos"> 60</span><span class="w">    </span><span class="n">PORTB</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">PB0</span><span class="p">);</span>
<span class="linenos"> 61</span><span class="w">    </span>
<span class="linenos"> 62</span><span class="w">    </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">raw_input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">analogRead</span><span class="p">(</span><span class="n">signal_pin</span><span class="p">);</span>
<span class="linenos"> 63</span>
<span class="linenos"> 64</span><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">millivolt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">raw_input</span><span class="o">*</span><span class="mf">5000.0</span><span class="p">)</span><span class="o">/</span><span class="mf">1023.0</span><span class="p">;</span>
<span class="linenos"> 65</span><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">volt_filtered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 66</span><span class="w">    </span><span class="n">volt_filtered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iir_filter_run</span><span class="p">(</span><span class="n">millivolt</span><span class="p">);</span>
<span class="linenos"> 67</span>
<span class="linenos"> 68</span><span class="w">    </span><span class="c1">//char millivolt_str[8];</span>
<span class="linenos"> 69</span><span class="w">    </span><span class="c1">//dtostrf(millivolt, 4, 2, millivolt_str);</span>
<span class="linenos"> 70</span>
<span class="linenos"> 71</span><span class="w">    </span><span class="c1">//char volt_filtered_str[6];</span>
<span class="linenos"> 72</span><span class="w">    </span><span class="c1">//dtostrf(volt_filtered, 4, 2, volt_filtered_str);</span>
<span class="linenos"> 73</span><span class="w">    </span>
<span class="linenos"> 74</span><span class="w">    </span><span class="c1">//snprintf(buffer, 32, &quot;%s,%s\r\n&quot;, millivolt_str, volt_filtered_str);</span>
<span class="linenos"> 75</span>
<span class="linenos"> 76</span><span class="w">    </span><span class="c1">//Serial.write(buffer);</span>
<span class="linenos"> 77</span><span class="w">    </span><span class="c1">//Serial.print(&quot;,&quot;);</span>
<span class="linenos"> 78</span><span class="w">    </span><span class="c1">//Serial.println(volt_filtered);</span>
<span class="linenos"> 79</span>
<span class="linenos"> 80</span>
<span class="linenos"> 81</span><span class="w">    </span><span class="c1">// TODO: Find a better way to solve this:</span>
<span class="linenos"> 82</span>
<span class="linenos"> 83</span><span class="w">    </span><span class="cm">/**</span>
<span class="linenos"> 84</span><span class="cm">     * Send the raw binary data of the floats.</span>
<span class="linenos"> 85</span><span class="cm">     * This is the most efficient way (in terms of UART baud rate),</span>
<span class="linenos"> 86</span><span class="cm">     * but the receiver needs to be able to interpret the data properly.</span>
<span class="linenos"> 87</span><span class="cm">     */</span>
<span class="linenos"> 88</span>
<span class="linenos"> 89</span><span class="w">    </span><span class="c1">// The following approach violates aliasing rules in recent versions of the C/C++ standards.</span>
<span class="linenos"> 90</span><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="linenos"> 91</span><span class="w">    </span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">millivolt</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">255</span><span class="p">;</span>
<span class="linenos"> 92</span><span class="w">    </span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">millivolt</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w">  </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">255</span><span class="p">;</span>
<span class="linenos"> 93</span><span class="w">    </span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">millivolt</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">255</span><span class="p">;</span>
<span class="linenos"> 94</span><span class="w">    </span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">millivolt</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">24</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">255</span><span class="p">;</span>
<span class="linenos"> 95</span>
<span class="linenos"> 96</span><span class="w">    </span><span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">volt_filtered</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">255</span><span class="p">;</span>
<span class="linenos"> 97</span><span class="w">    </span><span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">volt_filtered</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w">  </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">255</span><span class="p">;</span>
<span class="linenos"> 98</span><span class="w">    </span><span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">volt_filtered</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">255</span><span class="p">;</span>
<span class="linenos"> 99</span><span class="w">    </span><span class="n">buf</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">volt_filtered</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">24</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">255</span><span class="p">;</span>
<span class="linenos">100</span>
<span class="linenos">101</span><span class="w">    </span><span class="c1">//uint32_t millivolt_i;</span>
<span class="linenos">102</span><span class="w">    </span><span class="c1">//memccpy(&amp;millivolt_i, &amp;millivolt, sizeof(millivolt));</span>
<span class="linenos">103</span>
<span class="linenos">104</span><span class="w">    </span><span class="n">Serial</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="mh">0xaa</span><span class="p">);</span><span class="w"> </span><span class="c1">// Start byte for sync</span>
<span class="linenos">105</span><span class="w">    </span><span class="c1">//Serial.write(0xbb);</span>
<span class="linenos">106</span><span class="w">    </span><span class="n">Serial</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
<span class="linenos">107</span><span class="w">    </span><span class="n">Serial</span><span class="p">.</span><span class="n">flush</span><span class="p">();</span>
<span class="linenos">108</span><span class="w">    </span>
<span class="linenos">109</span><span class="w">    </span><span class="c1">//Serial.write((uint32_t)millivolt);</span>
<span class="linenos">110</span><span class="w">    </span><span class="c1">//Serial.write((uint32_t)volt_filtered);</span>
<span class="linenos">111</span>
<span class="linenos">112</span><span class="w">    </span><span class="n">PORTB</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">PB0</span><span class="p">);</span>
<span class="linenos">113</span>
<span class="linenos">114</span><span class="w">    </span><span class="n">prev_millis_timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">millis_timestamp</span><span class="p">;</span>
<span class="linenos">115</span><span class="w">  </span><span class="p">}</span>
<span class="linenos">116</span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="notch-filter">
<h3>Notch filter<a class="headerlink" href="#notch-filter" title="Permalink to this headline">¶</a></h3>
</section>
</section>
<section id="cascaded-integrator-comb-cic">
<h2>Cascaded integrator comb (CIC)<a class="headerlink" href="#cascaded-integrator-comb-cic" title="Permalink to this headline">¶</a></h2>
<p>A CIC filter is a type of FIR filter, where the coefficients are uniform. CIC filters are not a popular choice for general purpose filtering, but they are popular as an anti-aliasing filter before downsampling (decimation) of a signal to a lower sample rate.</p>
<section id="id1">
<h3>Moving average<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
</section>
<section id="decimation-of-a-pdm-signal-from-a-digital-mems-microphone">
<h3>Decimation of a PDM signal from a digital MEMS microphone<a class="headerlink" href="#decimation-of-a-pdm-signal-from-a-digital-mems-microphone" title="Permalink to this headline">¶</a></h3>
</section>
</section>
</section>


                </div>
              </div>
            </div>
          </div>
        </div>
        
        
      </div><!-- /row -->

      <!-- row -->
      <div class="row footer-relbar">
<div id="navbar-related" class=" related navbar navbar-default" role="navigation" aria-label="related navigation">
  <div class="navbar-inner">
    <ul class="nav navbar-nav ">
        <li><a href="../../index.html">ELE102 Microcontroller course v1.1.0 documentation</a></li>
    </ul>
<ul class="nav navbar-nav pull-right hidden-xs hidden-sm">
      
        <li><a href="assembly_programming.html" title="Assembly programming" >previous</a></li>
        <li><a href="floating_point_numbers.html" title="Floating point number representation" >next</a></li>
        <li><a href="../../genindex.html" title="General Index" >index</a></li>
        <li><a href="#">top</a></li> 
      
    </ul>
  </div>
</div>
      </div><!-- /row -->

      <!-- footer -->
      <footer role="contentinfo">
          &copy; Copyright 2022, Gizem Ateş &amp; Eirik Haustveit.
        Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 4.5.0.
      </footer>
      <!-- /footer -->

    </div>
    <!-- /container -->

  </body>
</html>