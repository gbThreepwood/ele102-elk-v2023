<!DOCTYPE html>




<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Additional Chapters &mdash; ELE102 Microcontroller course v1.1.0 documentation</title>
    <meta name="description" content="">
    <meta name="author" content="">

    

<link rel="stylesheet" href="../../_static/css/basicstrap-base.css" type="text/css" />
<link rel="stylesheet" id="current-theme" href="../../_static/css/bootstrap3/bootstrap.min.css" type="text/css" />
<link rel="stylesheet" id="current-adjust-theme" type="text/css" />

<link rel="stylesheet" href="../../_static/css/font-awesome.min.css">

<style type="text/css">
  body {
    padding-top: 60px;
    padding-bottom: 40px;
  }
</style>

<link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
<link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
<link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
<link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
<link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
    
<script type="text/javascript">
  var DOCUMENTATION_OPTIONS = {
            URL_ROOT:    '../../',
            VERSION:     'v1.1.0',
            COLLAPSE_INDEX: false,
            FILE_SUFFIX: '.html',
            HAS_SOURCE:  true
  };
</script>
    <script type="text/javascript" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/js/jquery.min.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script type="text/javascript" src="../../_static/js/bootstrap3.min.js"></script>
<script type="text/javascript" src="../../_static/js/jquery.cookie.min.js"></script>
<script type="text/javascript" src="../../_static/js/basicstrap.js"></script>
<script type="text/javascript">
</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="top" title="ELE102 Microcontroller course v1.1.0 documentation" href="../../index.html" />
    <link rel="next" title="Infrared (IR) communication" href="../Projects/ir_communication.html" />
    <link rel="prev" title="Additional material for lesson 13" href="../Lessons-additional/L13_additional.html" /> 
  </head>
  <body role="document">
    <div id="navbar-top" class="navbar navbar-fixed-top navbar-default" role="navigation" aria-label="top navigation">
      <div class="container-fluid">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../../index.html">ELE102 Microcontroller course v1.1.0 documentation</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav navbar-right">
              <li class="dropdown visible-xs">
                <a role="button" id="localToc" data-toggle="dropdown" data-target="#" href="#">Table Of Contents <b class="caret"></b></a>
                <ul class="dropdown-menu localtoc sp-localtoc" role="menu" aria-labelledby="localToc">
                <ul>
<li><a class="reference internal" href="#">Additional Chapters</a><ul>
<li><a class="reference internal" href="#bit-binary-counter">4-bit binary counter</a></li>
<li><a class="reference internal" href="#using-a-potentiometer-to-test-the-analog-to-digital-converter">Using a potentiometer to test the analog to digital converter</a></li>
<li><a class="reference internal" href="#debounce-of-mechanical-switch">Debounce of mechanical switch</a><ul>
<li><a class="reference internal" href="#generalizing-the-concept">Generalizing the concept</a><ul>
<li><a class="reference internal" href="#rough-timing-in-arduino">Rough Timing in Arduino</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#operation">Operation</a></li>
<li><a class="reference internal" href="#usage">Usage</a></li>
<li><a class="reference internal" href="#stopwatch">Stopwatch</a></li>
<li><a class="reference internal" href="#assignment-1-real-time-clock">Assignment 1 : Real time clock</a></li>
<li><a class="reference internal" href="#switching-frequency-modulation-example">Switching frequency modulation example</a></li>
<li><a class="reference internal" href="#arduino-math-functions">Arduino math functions</a><ul>
<li><a class="reference internal" href="#trigonometry">Trigonometry</a></li>
</ul>
</li>
<li><a class="reference internal" href="#simple-motor-drive-example-with-speed-control">Simple motor drive example with speed control</a></li>
</ul>
</li>
</ul>

                </ul>
              </li>

            
              <li><a href="../Lessons-additional/L13_additional.html" title="Additional material for lesson 13" accesskey="P">previous </a></li>
              <li><a href="../Projects/ir_communication.html" title="Infrared (IR) communication" accesskey="N">next </a></li>
              <li><a href="../../genindex.html" title="General Index" accesskey="I">index </a></li>
            

            <li class="visible-xs">
                <form class="search form-search form-inline navbar-form navbar-right sp-searchbox" action="../../search.html" method="get">
                  <div class="input-append input-group">
                    <input type="text" class="search-query form-control" name="q" placeholder="Search...">
                    <span class="input-group-btn">
                    <input type="submit" class="btn" value="Go" />
                    </span>
                  </div>
                  <input type="hidden" name="check_keywords" value="yes" />
                  <input type="hidden" name="area" value="default" />
                </form>
            </li>

            

          </ul>

        </div>
      </div>
    </div>
    

    <!-- container -->
    <div class="container-fluid">

      <!-- row -->
      <div class="row">
         
<div class="col-md-3 hidden-xs" id="sidebar-wrapper">
  <div class="sidebar hidden-xs" role="navigation" aria-label="main navigation">
<h3><a href="../../index.html">Table of Contents</a></h3>
<p class="caption" role="heading"><span class="caption-text">Lessons:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Lessons/L0_Introduction_elk.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons/software_hardware_preparations.html">Software and hardware preparations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons/L1a_UC_intro.html">Lesson 1a: What is a Microcontroller</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons/L1b_Arduino_intro.html">Lesson 1b: Introduction to Arduino</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons/L2_digital_io.html">Lesson 2: Digital I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons/L3_digital_io_and_timing.html">Lesson 3: Use of digital I/O and timing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons/L4_dac_pwm.html">Lesson 4: Analog output (PWM)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons/L5_adc.html">Lesson 5: Analog to digital conversion (ADC)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons/L6_serial_io.html">Lesson 6: Serial I/O</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Additional material:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L1_additional.html">Additional material lesson 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L2_additional.html">Additional material lesson 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L3_additional.html">Additional material lesson 3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L4_additional.html">Additional material lesson 4</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L5_additional.html">Additional material lesson 5</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L6_additional.html">Additional material lesson 6</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L7_additional.html">Additional material lesson 7</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L8_additional.html">Additional material lesson 8</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L9_additional.html">Additional material lesson 9</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L10_additional.html">Additional material lesson 10</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L11_additional.html">Additional material lesson 11</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L12_additional.html">Additional material lesson 12</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L13_additional.html">Additional material lesson 13</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Projects:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Binary counter</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#bit-binary-counter">4-bit binary counter</a></li>
<li class="toctree-l2"><a class="reference internal" href="#using-a-potentiometer-to-test-the-analog-to-digital-converter">Using a potentiometer to test the analog to digital converter</a></li>
<li class="toctree-l2"><a class="reference internal" href="#debounce-of-mechanical-switch">Debounce of mechanical switch</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#generalizing-the-concept">Generalizing the concept</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#rough-timing-in-arduino">Rough Timing in Arduino</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#operation">Operation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#usage">Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="#stopwatch">Stopwatch</a></li>
<li class="toctree-l2"><a class="reference internal" href="#assignment-1-real-time-clock">Assignment 1 : Real time clock</a></li>
<li class="toctree-l2"><a class="reference internal" href="#switching-frequency-modulation-example">Switching frequency modulation example</a></li>
<li class="toctree-l2"><a class="reference internal" href="#arduino-math-functions">Arduino math functions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#trigonometry">Trigonometry</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#simple-motor-drive-example-with-speed-control">Simple motor drive example with speed control</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/ir_communication.html">Infrared remote</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/adaptive_line_enhancer.html">Adaptive line enhancer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/audio_processing.html">Audio processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/RC_car.html">Cool Project: RC Car (Bluetooth or Joystick)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/Robotarm.html">Cool Project: Simple Robot Arm (Bluetooth or Joystick)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/dc_motor_control.html">DC motor control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/digital_piano.html">Digital piano</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/digital_synth.html">Digital synth</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/dtmf_generator.html">DTMF generator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/frequency_estimator.html">Frequency estimator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/induction_motor_control.html">Induction motor control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/lorawan.html">LoRaWan</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/phase_displacement.html">Phase displacement</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/phase_locked_loop.html">Phase locked loop (PLL)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/phasor_estimation.html">Phasor estimation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/radio_transmitter.html">Radio transmitter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/stepper_motor_control.html">Stepper motor control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/synchroscope.html">Synchroscope</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/thyristor_controller.html">Thyristor controller</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Appendices:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="low_power_operation.html">Low power operation</a></li>
<li class="toctree-l1"><a class="reference internal" href="stacks_queues_lists.html">Stacks, Queues, Lists</a></li>
<li class="toctree-l1"><a class="reference internal" href="assembly_programming.html">Assembly programming</a></li>
<li class="toctree-l1"><a class="reference internal" href="digital_filters.html">Digital filters</a></li>
<li class="toctree-l1"><a class="reference internal" href="floating_point_numbers.html">Floating point numbers</a></li>
<li class="toctree-l1"><a class="reference internal" href="kalman_filter.html">Kalman filter</a></li>
<li class="toctree-l1"><a class="reference internal" href="the_build_process.html">The build process</a></li>
<li class="toctree-l1"><a class="reference internal" href="direct_register_manipulations.html">Direct register manipulation</a></li>
</ul>

<div id="searchbox" role="search">
  <h3>Quick search</h3>
  <form class="search form-inline" action="../../search.html" method="get">
      <div class="input-append input-group">
        <input type="text" class="search-query form-control" name="q" placeholder="Search...">
        <span class="input-group-btn">
        <input type="submit" class="btn" value="Go" />
        </span>
      </div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="../Lessons-additional/L13_additional.html"
                          title="previous chapter">Additional material for lesson 13</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="../Projects/ir_communication.html"
                          title="next chapter">Infrared (IR) communication</a></p>
  </div>
  </div>
</div> 
        

        <div class="col-md-9" id="content-wrapper">
          <div class="document" role="main">
            <div class="documentwrapper">
              <div class="bodywrapper">
                <div class="body">
                  
  <section id="additional-chapters">
<span id="additionals"></span><h1>Additional Chapters<a class="headerlink" href="#additional-chapters" title="Permalink to this headline">¶</a></h1>
<section id="bit-binary-counter">
<h2>4-bit binary counter<a class="headerlink" href="#bit-binary-counter" title="Permalink to this headline">¶</a></h2>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This example is somewhat advanced, and you should not worry if you are unable to follow all the details. They will become clear as the course progresses.</p>
</div>
<p>In order to demonstrate how the digital output really works we are goint to create a 4-bit binary counter. First we will use the Arduino function to access the digital outputs, and afterwards we will access the output register directly, in order to demonstrate how this can optimize our program.</p>
<p>Start by building the following circuit. In order to comply with the upcoming example code, you should use the same digital output pins, as shown in the figure.</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/4_led_bb.png"><img alt="../../_images/4_led_bb.png" src="../../_images/4_led_bb.png" style="width: 463.5px; height: 660.0px;" /></a>
</figure>
<p>The following program counts the LED’s in the binary sequence from 0 to 15. Each call to <cite>digitalWrite</cite> only updates one output, and thus we use several conditional sentences to make sure the functions are invoked at the correct time. In addition the program prints the status of the counter to the serial port.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Arduino.h&gt;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">setup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// put your setup code here, to run once:</span>
<span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">OUTPUT</span><span class="p">);</span>
<span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="n">OUTPUT</span><span class="p">);</span>
<span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="n">OUTPUT</span><span class="p">);</span>
<span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="n">OUTPUT</span><span class="p">);</span>

<span class="w">  </span><span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>

<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">loop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// put your main code here, to run repeatedly:</span>

<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">){</span>

<span class="w">    </span><span class="n">Serial</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;Tallet er: &quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="w">    </span><span class="n">Serial</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">%</span><span class="mi">2</span><span class="p">)</span>
<span class="w">      </span><span class="n">digitalWrite</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">HIGH</span><span class="p">);</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="n">digitalWrite</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">LOW</span><span class="p">);</span>


<span class="w">    </span><span class="k">if</span><span class="p">((</span><span class="n">i</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="p">)</span>
<span class="w">      </span><span class="n">digitalWrite</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="n">HIGH</span><span class="p">);</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="n">digitalWrite</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="n">LOW</span><span class="p">);</span>


<span class="w">    </span><span class="k">if</span><span class="p">((</span><span class="n">i</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="p">)</span>
<span class="w">      </span><span class="n">digitalWrite</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="n">HIGH</span><span class="p">);</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="n">digitalWrite</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="n">LOW</span><span class="p">);</span>


<span class="w">    </span><span class="k">if</span><span class="p">((</span><span class="n">i</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="p">)</span>
<span class="w">      </span><span class="n">digitalWrite</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="n">HIGH</span><span class="p">);</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="n">digitalWrite</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="n">LOW</span><span class="p">);</span>

<span class="w">    </span><span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<p>Computers work with binary numbers, and thus one might be suprised about the complexity of the code involved just to make the computer count from 0 to 15, and indeed there is a simpler solution.</p>
<p>The problem arrises from the <cite>digitalWrite</cite> function, restricting our access to only one output at a time. Internally though, at a lower level, the outputs are contained in 8-bit registers, and a single CPU instruction is capable of modifying 8 outputs. If we can figure out which register to modify, we could simply increment the value of this register by one, from 0 to 15 to achieve the same result. Direct register access will make your code less portable and readable, and thus it should be used with causion.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>A experienced programmer would typically write some kind of wrapper to isolate as much as possible of the logical code, from the code that directly interacts with hardware. That way only the direct hardware access code must be changed if porting to a different microcontroller.</p>
</div>
<p>By looking at the Arduino UNO pinout, we see that the pins we happen to be using (pin 4 - 7) are connected to port PD4 to PD7 in the microcontroller. The following code configures these pins as outputs, and sets PD7, and PD5 high, illuminating the two LED’s.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Arduino.h&gt;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">setup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// put your setup code here, to run once:</span>

<span class="w">  </span><span class="n">DDRD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b11110000</span><span class="p">;</span><span class="w"> </span><span class="c1">// Configure PD4 - PD7 as outputs, the rest as inputs.</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">loop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// put your main code here, to run repeatedly:</span>

<span class="w">  </span><span class="n">PORTD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b10100000</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The counter may be implemented by incrementing the 4 most significant bits of the <cite>PORTD</cite> register from 0 to 15. This is achieved by shifthing the value in the counter variable <cite>i</cite> 4 places to the left using the bit-shift operator <cite>&lt;&lt;</cite>.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Arduino.h&gt;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">setup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// put your setup code here, to run once:</span>

<span class="w">  </span><span class="n">DDRD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b11110000</span><span class="p">;</span><span class="w"> </span><span class="c1">// Configure PD4 - PD7 as outputs, the rest as inputs.</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">loop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// put your main code here, to run repeatedly:</span>

<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
<span class="w">    </span><span class="n">PORTD</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span>
<span class="w">    </span><span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>As a simple exercise you could try to extend the program to a 8-bit counter. In that case you might want to reduce the time delay.</p>
<p>Creating a counter with more than 8 bit introduce an additional challenge because you have to manipulate more than one output register. It is however rather straightforward once you know how to do bitwise manipulations.</p>
</div>
</section>
<section id="using-a-potentiometer-to-test-the-analog-to-digital-converter">
<h2>Using a potentiometer to test the analog to digital converter<a class="headerlink" href="#using-a-potentiometer-to-test-the-analog-to-digital-converter" title="Permalink to this headline">¶</a></h2>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This is a rather complex example, and is mostly intended as a demonstration. It is not expected that you will be able to follow all the details of the code this early in the course.</p>
</div>
<p>In this example we will be using a potentiometer to apply a varying voltage to the ADC of the Arduino. The conversion result will be fed back to us using the serial UART. In addition a bar of 8 LED’s will be used to indicate the voltage level. The software supports two modes for the LED display, a dot-mode, and a bar-mode.</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/potmeter_reading_bb.png"><img alt="../../_images/potmeter_reading_bb.png" src="../../_images/potmeter_reading_bb.png" style="width: 484.5px; height: 660.0px;" /></a>
</figure>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This code could (should?) be improved.</p>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Arduino.h&gt;</span>

<span class="k">enum</span><span class="w"> </span><span class="n">State_enum</span><span class="w"> </span><span class="p">{</span><span class="n">BAR_STATE</span><span class="p">,</span><span class="w"> </span><span class="n">DOT_STATE</span><span class="p">};</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">led_bar</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">led_dot</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">buttonPressed</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">);</span>


<span class="kt">void</span><span class="w"> </span><span class="nf">setup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// put your setup code here, to run once:</span>

<span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">OUTPUT</span><span class="p">);</span>
<span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">OUTPUT</span><span class="p">);</span>
<span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">OUTPUT</span><span class="p">);</span>
<span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="n">OUTPUT</span><span class="p">);</span>
<span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="n">OUTPUT</span><span class="p">);</span>
<span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="n">OUTPUT</span><span class="p">);</span>
<span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="n">OUTPUT</span><span class="p">);</span>
<span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="n">OUTPUT</span><span class="p">);</span>

<span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="n">INPUT</span><span class="p">);</span>

<span class="w">  </span><span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>

<span class="p">}</span>


<span class="kt">void</span><span class="w"> </span><span class="nf">loop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="c1">// put your main code here, to run repeatedly:</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">adc_reading</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">voltage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">past</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BAR_STATE</span><span class="p">;</span>

<span class="w">  </span><span class="k">for</span><span class="p">(;;){</span>

<span class="w">    </span><span class="n">delay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<span class="w">    </span><span class="n">adc_reading</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">analogRead</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="n">voltage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">adc_reading</span><span class="o">*</span><span class="mf">0.00489</span><span class="p">;</span>


<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Only write to the serial port once every second.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="k">if</span><span class="p">((</span><span class="n">millis</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">past</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1000</span><span class="p">){</span>
<span class="w">      </span><span class="n">past</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">millis</span><span class="p">();</span>

<span class="w">      </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;ADC verdi: &quot;</span><span class="p">);</span>
<span class="w">      </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">adc_reading</span><span class="p">);</span>
<span class="w">      </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;Spenning: &quot;</span><span class="p">);</span>
<span class="w">      </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">voltage</span><span class="p">);</span>
<span class="w">      </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">BAR_STATE</span><span class="p">:</span>

<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">buttonPressed</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="w">        </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DOT_STATE</span><span class="p">;</span>

<span class="w">      </span><span class="n">led_bar</span><span class="p">(</span><span class="n">adc_reading</span><span class="p">);</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">DOT_STATE</span><span class="p">:</span>

<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">buttonPressed</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="w">        </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BAR_STATE</span><span class="p">;</span>

<span class="w">      </span><span class="n">led_dot</span><span class="p">(</span><span class="n">adc_reading</span><span class="p">);</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>

<span class="w">    </span><span class="k">default</span><span class="o">:</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">led_bar</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">adc_reading</span><span class="p">){</span>
<span class="w">   </span><span class="cm">/*</span>
<span class="cm">    * LED is connected to PD2 - PD7 and PB0 - PB1.</span>
<span class="cm">    */</span>
<span class="w">   </span><span class="k">if</span><span class="p">(</span><span class="n">adc_reading</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">128</span><span class="p">)</span>
<span class="w">     </span><span class="n">digitalWrite</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">HIGH</span><span class="p">);</span>
<span class="w">   </span><span class="k">else</span>
<span class="w">     </span><span class="n">digitalWrite</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">LOW</span><span class="p">);</span>
<span class="w">   </span><span class="k">if</span><span class="p">(</span><span class="n">adc_reading</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">256</span><span class="p">)</span>
<span class="w">     </span><span class="n">digitalWrite</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">HIGH</span><span class="p">);</span>
<span class="w">   </span><span class="k">else</span>
<span class="w">     </span><span class="n">digitalWrite</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">LOW</span><span class="p">);</span>
<span class="w">   </span><span class="k">if</span><span class="p">(</span><span class="n">adc_reading</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">384</span><span class="p">)</span>
<span class="w">     </span><span class="n">digitalWrite</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">HIGH</span><span class="p">);</span>
<span class="w">   </span><span class="k">else</span>
<span class="w">     </span><span class="n">digitalWrite</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">LOW</span><span class="p">);</span>
<span class="w">   </span><span class="k">if</span><span class="p">(</span><span class="n">adc_reading</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">512</span><span class="p">)</span>
<span class="w">     </span><span class="n">digitalWrite</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="n">HIGH</span><span class="p">);</span>
<span class="w">   </span><span class="k">else</span>
<span class="w">     </span><span class="n">digitalWrite</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="n">LOW</span><span class="p">);</span>
<span class="w">   </span><span class="k">if</span><span class="p">(</span><span class="n">adc_reading</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">640</span><span class="p">)</span>
<span class="w">     </span><span class="n">digitalWrite</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="n">HIGH</span><span class="p">);</span>
<span class="w">   </span><span class="k">else</span>
<span class="w">     </span><span class="n">digitalWrite</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="n">LOW</span><span class="p">);</span>
<span class="w">   </span><span class="k">if</span><span class="p">(</span><span class="n">adc_reading</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">768</span><span class="p">)</span>
<span class="w">     </span><span class="n">digitalWrite</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="n">HIGH</span><span class="p">);</span>
<span class="w">   </span><span class="k">else</span>
<span class="w">     </span><span class="n">digitalWrite</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="n">LOW</span><span class="p">);</span>
<span class="w">   </span><span class="k">if</span><span class="p">(</span><span class="n">adc_reading</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">896</span><span class="p">)</span>
<span class="w">     </span><span class="n">digitalWrite</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="n">HIGH</span><span class="p">);</span>
<span class="w">   </span><span class="k">else</span>
<span class="w">     </span><span class="n">digitalWrite</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="n">LOW</span><span class="p">);</span>
<span class="w">   </span><span class="k">if</span><span class="p">(</span><span class="n">adc_reading</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1023</span><span class="p">)</span>
<span class="w">     </span><span class="n">digitalWrite</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="n">HIGH</span><span class="p">);</span>
<span class="w">   </span><span class="k">else</span>
<span class="w">     </span><span class="n">digitalWrite</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="n">LOW</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">led_dot</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">adc_reading</span><span class="p">){</span>

<span class="w">  </span><span class="k">if</span><span class="p">((</span><span class="n">adc_reading</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">adc_reading</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">128</span><span class="p">))</span>
<span class="w">    </span><span class="n">digitalWrite</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">HIGH</span><span class="p">);</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="n">digitalWrite</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">LOW</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="p">((</span><span class="n">adc_reading</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">128</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">adc_reading</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">240</span><span class="p">))</span>
<span class="w">    </span><span class="n">digitalWrite</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">HIGH</span><span class="p">);</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="n">digitalWrite</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">LOW</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="p">((</span><span class="n">adc_reading</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">240</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">adc_reading</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">351</span><span class="p">))</span>
<span class="w">    </span><span class="n">digitalWrite</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">HIGH</span><span class="p">);</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="n">digitalWrite</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">LOW</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="p">((</span><span class="n">adc_reading</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">351</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">adc_reading</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">462</span><span class="p">))</span>
<span class="w">    </span><span class="n">digitalWrite</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="n">HIGH</span><span class="p">);</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="n">digitalWrite</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="n">LOW</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="p">((</span><span class="n">adc_reading</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">462</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">adc_reading</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">573</span><span class="p">))</span>
<span class="w">     </span><span class="n">digitalWrite</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="n">HIGH</span><span class="p">);</span>
<span class="w">   </span><span class="k">else</span>
<span class="w">     </span><span class="n">digitalWrite</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="n">LOW</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="p">((</span><span class="n">adc_reading</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">573</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">adc_reading</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">648</span><span class="p">))</span>
<span class="w">     </span><span class="n">digitalWrite</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="n">HIGH</span><span class="p">);</span>
<span class="w">   </span><span class="k">else</span>
<span class="w">     </span><span class="n">digitalWrite</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="n">LOW</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="p">((</span><span class="n">adc_reading</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">648</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">adc_reading</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">795</span><span class="p">))</span>
<span class="w">     </span><span class="n">digitalWrite</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="n">HIGH</span><span class="p">);</span>
<span class="w">   </span><span class="k">else</span>
<span class="w">     </span><span class="n">digitalWrite</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="n">LOW</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">adc_reading</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">795</span><span class="p">)</span>
<span class="w">     </span><span class="n">digitalWrite</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="n">HIGH</span><span class="p">);</span>
<span class="w">   </span><span class="k">else</span>
<span class="w">     </span><span class="n">digitalWrite</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="n">LOW</span><span class="p">);</span>

<span class="w"> </span><span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check if button is pressed, i.e. if it is high, and it was low before.</span>
<span class="cm"> */</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">buttonPressed</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">digital_input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">lastStates</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">// Store the states of digital input 0 - 15.</span>

<span class="w">  </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">digitalRead</span><span class="p">(</span><span class="n">digital_input</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="p">((</span><span class="n">lastStates</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">digital_input</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">lastStates</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">digital_input</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">HIGH</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="debounce-of-mechanical-switch">
<h2>Debounce of mechanical switch<a class="headerlink" href="#debounce-of-mechanical-switch" title="Permalink to this headline">¶</a></h2>
<p>A mechanical switch will often generate spurious open/close transitions in a short period after it has been activated. It is a risk that these spurious transitions are interpreted as multiple signals from the switch. In order to avoid these problems some form of debounce remedy should be applied. This could be a hardware solution, a software solution or a combination of the two.</p>
<p>If a software solution is desired, one possibility is to check the button state twice, within a short time windows. I.e. check, delay, check again.</p>
<p>Hardware solutions include analog filters using resitors and capacitors, as well as using a SR-latch.</p>
<p>Here the only function that you need to know for debugging your code is <code class="code docutils literal notranslate"><span class="pre">Serial.print()</span></code>. With this function, you can see some text on your <em>Serial Monitor</em>. The simplest setup to do it is as it shown:</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">Simple Serial</span><a class="headerlink" href="#id2" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span><span class="w"> </span><span class="c1">// open the serial port at 9600 bps</span>
<span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">loop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Hello world&quot;</span><span class="p">);</span><span class="w"> </span><span class="c1">// text written what you want to see</span>
<span class="w">     </span><span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span><span class="w"> </span><span class="c1">// delay 0.5 seconds before the sending</span>
<span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
</div>
<p>Let’s write a program that takes the button state <em>detecting edges</em> both rising and falling, and write it on your serial monitor <a class="footnote-reference brackets" href="#f1" id="id1">1</a> .</p>
<p>First, let’s connect the button:</p>
<figure class="align-center">
<img alt="../../_images/buttonconnect_schematic.png" src="../../_images/buttonconnect_schematic.png" />
</figure>
<p>This will look like that with your breadboard and Arduino:</p>
<figure class="align-center">
<img alt="../../_images/buttonconnect.png" src="../../_images/buttonconnect.png" />
</figure>
<section id="generalizing-the-concept">
<h3>Generalizing the concept<a class="headerlink" href="#generalizing-the-concept" title="Permalink to this headline">¶</a></h3>
<p>The following example depicts a useful function for rising edge detection of multiple inputs.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm"> * Check if button is pressed, i.e. if it is high, and it was low before.</span>
<span class="cm"> */</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">buttonPressed</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">digital_input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">lastStates</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">// Store the states of digital input 0 - 15.</span>

<span class="w">  </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">digitalRead</span><span class="p">(</span><span class="n">digital_input</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="p">((</span><span class="n">lastStates</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">digital_input</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">lastStates</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">digital_input</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">HIGH</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<section id="rough-timing-in-arduino">
<h4>Rough Timing in Arduino<a class="headerlink" href="#rough-timing-in-arduino" title="Permalink to this headline">¶</a></h4>
<p>The Arduino functions associated with timing that we will be using in this tutorial are:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.arduino.cc/reference/en/language/functions/time/delay/">delay()</a></p></li>
<li><p><a class="reference external" href="https://www.arduino.cc/reference/en/language/functions/time/delaymicroseconds/">delayMicroseconds()</a></p></li>
<li><p><a class="reference external" href="https://www.arduino.cc/reference/en/language/functions/time/millis/">millis()</a></p></li>
<li><p><a class="reference external" href="https://www.arduino.cc/reference/en/language/functions/time/micros/">micros()</a></p></li>
</ul>
</section>
</section>
</section>
<section id="operation">
<h2>Operation<a class="headerlink" href="#operation" title="Permalink to this headline">¶</a></h2>
<p>The Atmega 328 has several built in hardware timers (two 8-bit and one 16-bit). These timers allow for many advanced timing applications. The Arduino library utilizes one of these timers for a counter that counts the number of microseconds since the last time the controller was restarted. Several functions are available for utilization of this counter value.</p>
<p>The <cite>millis()</cite> function returns the the number of milliseconds since the last time the controller was restarted. It is using a 32-bit unsigned integer to store the counter value, thus the maximum value is given by:</p>
<div class="math notranslate nohighlight">
\[2^{32} = 4294967296\]</div>
<p>If we convert this value from milliseconds, to days we get:</p>
<div class="math notranslate nohighlight">
\[\frac{4294967296}{1000 \cdot 60 \cdot 60 \cdot 24} = 49.7\]</div>
<p>Thus we see that the counter will wrap around after approximately 50 days. This should be accounted for in applications where the controller is running continously for extended periods of time.</p>
<p>The following code is excerpt from the Arduino library, and shows the implementation of the <cite>millis()</cite> function:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="nf">millis</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">m</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">oldSREG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SREG</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// disable interrupts while we read timer0_millis or we might get an</span>
<span class="w">        </span><span class="c1">// inconsistent value (e.g. in the middle of a write to timer0_millis)</span>
<span class="w">        </span><span class="n">cli</span><span class="p">();</span>
<span class="w">        </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timer0_millis</span><span class="p">;</span>
<span class="w">        </span><span class="n">SREG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oldSREG</span><span class="p">;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">m</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If higher accuracy is required there is also a <cite>micros()</cite> function, returning the number of microseconds since the last reboot.</p>
<p>The following code depicts the implementation of the <cite>micros()</cite> function:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="nf">micros</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">m</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">oldSREG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SREG</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">;</span>

<span class="w">        </span><span class="n">cli</span><span class="p">();</span>
<span class="w">        </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timer0_overflow_count</span><span class="p">;</span>
<span class="cp">#if defined(TCNT0)</span>
<span class="w">        </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TCNT0</span><span class="p">;</span>
<span class="cp">#elif defined(TCNT0L)</span>
<span class="w">        </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TCNT0L</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="w">        </span><span class="cp">#error TIMER 0 not defined</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef TIFR0</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">TIFR0</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">_BV</span><span class="p">(</span><span class="n">TOV0</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">255</span><span class="p">))</span>
<span class="w">                </span><span class="n">m</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">TIFR</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">_BV</span><span class="p">(</span><span class="n">TOV0</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">255</span><span class="p">))</span>
<span class="w">                </span><span class="n">m</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="w">        </span><span class="n">SREG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oldSREG</span><span class="p">;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">((</span><span class="n">m</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mi">64</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">clockCyclesPerMicrosecond</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In embedded systems it is often required to write code that has some delay between executing different parts of the code. For very simple applications it might be sufficient to use code that simply blocks until a given amount of time has passed. The <cite>delay()</cite> function will block for the given number of milliseconds, before execution continues.</p>
<p>The <cite>delay()</cite> function is implemented as a so called waste routine. It wastes execution cycles while waiting for a counter to reach zero.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">delay</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">ms</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">        </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">micros</span><span class="p">();</span>

<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">ms</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">yield</span><span class="p">();</span>
<span class="w">                </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">micros</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">ms</span><span class="o">--</span><span class="p">;</span>
<span class="w">                        </span><span class="n">start</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If finer control over the delay is needed, the <cite>delayMicroseconds()</cite> function may be used. The code for this function is to involved to be included here, but it is available it the <a class="reference external" href="https://github.com/arduino/ArduinoCore-avr/blob/master/cores/arduino/wiring.c">official repository for Arduino</a></p>
</section>
<section id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h2>
<p>We have allready seen how the <cite>delay()</cite> function is used in the simple LED blink example. The <cite>millis()</cite> function allows us to do more interesting and useful delay implementations, where different parts of the code may execute while we are waiting for the required time to pass.</p>
</section>
<section id="stopwatch">
<h2>Stopwatch<a class="headerlink" href="#stopwatch" title="Permalink to this headline">¶</a></h2>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/digital_input_and_output_for_stop_watch_bb.png"><img alt="../../_images/digital_input_and_output_for_stop_watch_bb.png" src="../../_images/digital_input_and_output_for_stop_watch_bb.png" style="width: 477.0px; height: 660.0px;" /></a>
</figure>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Arduino.h&gt;</span>

<span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">led_pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">button_pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">setup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// put your setup code here, to run once:</span>
<span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="n">button_pin</span><span class="p">,</span><span class="n">INPUT</span><span class="p">);</span>
<span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="n">led_pin</span><span class="p">,</span><span class="n">OUTPUT</span><span class="p">);</span>
<span class="w">  </span><span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>

<span class="w">  </span><span class="n">digitalWrite</span><span class="p">(</span><span class="n">led_pin</span><span class="p">,</span><span class="n">LOW</span><span class="p">);</span>

<span class="w">  </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Setup complete.&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">loop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// put your main code here, to run repeatedly:</span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">button_past</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">button_now</span><span class="p">;</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">timer_active</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">start_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">stop_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">  </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">delta_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">timer_seconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">  </span><span class="n">button_now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">digitalRead</span><span class="p">(</span><span class="n">button_pin</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="p">((</span><span class="n">button_now</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">button_past</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)){</span><span class="w"> </span><span class="c1">// Falling edge is less prone to bounce</span>

<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">timer_active</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span>
<span class="w">      </span><span class="n">start_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">millis</span><span class="p">();</span>

<span class="w">      </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;Starttid: &quot;</span><span class="p">);</span>
<span class="w">      </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">start_time</span><span class="p">);</span>

<span class="w">      </span><span class="n">timer_active</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span><span class="p">{</span>
<span class="w">      </span>
<span class="w">      </span><span class="n">stop_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">millis</span><span class="p">();</span>
<span class="w">      </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;Stopptid: &quot;</span><span class="p">);</span>
<span class="w">      </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">stop_time</span><span class="p">);</span>

<span class="w">      </span><span class="n">delta_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stop_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="p">;</span>

<span class="w">      </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;Delta tid: &quot;</span><span class="p">);</span>
<span class="w">      </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">delta_time</span><span class="p">);</span>

<span class="w">      </span><span class="n">timer_seconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">delta_time</span><span class="o">/</span><span class="mf">1000.0</span><span class="p">;</span>
<span class="w">      </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;Delta tid sekunder: &quot;</span><span class="p">);</span>
<span class="w">      </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">timer_seconds</span><span class="p">);</span>
<span class="w">      </span><span class="n">timer_active</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w"> </span><span class="p">}</span>

<span class="w">  </span><span class="n">button_past</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">button_now</span><span class="p">;</span>

<span class="w">  </span><span class="n">delay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="assignment-1-real-time-clock">
<h2>Assignment 1 : Real time clock<a class="headerlink" href="#assignment-1-real-time-clock" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">setup</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">   </span><span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">//globale variable</span>
<span class="kt">int</span><span class="w"> </span><span class="n">Year</span><span class="o">=</span><span class="mi">2019</span><span class="p">;</span>
<span class="kt">int</span><span class="w"> </span><span class="n">Month</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<span class="kt">int</span><span class="w"> </span><span class="n">Date</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span>
<span class="kt">int</span><span class="w"> </span><span class="n">Hour</span><span class="o">=</span><span class="mi">12</span><span class="p">;</span>
<span class="kt">int</span><span class="w"> </span><span class="n">Minutes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="kt">int</span><span class="w"> </span><span class="n">Seconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">loop</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">   </span><span class="c1">//oppdater tidsvarable</span>
<span class="w">   </span><span class="n">Seconds</span><span class="o">++</span><span class="p">;</span><span class="w"> </span><span class="c1">//kompakt versjon av Second = Second + 1;</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Seconds</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">60</span><span class="p">)</span>
<span class="w">   </span><span class="p">{</span>
<span class="w">      </span><span class="n">Seconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">      </span><span class="n">Minutes</span><span class="o">++</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="c1">// Skriv ut verdier</span>
<span class="w">   </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">Hour</span><span class="p">);</span>
<span class="w">   </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">Minutes</span><span class="p">);</span>
<span class="w">   </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">Seconds</span><span class="p">);</span>

<span class="w">   </span><span class="c1">// vent</span>
<span class="w">   </span><span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span><span class="w"> </span><span class="c1">// vent et sekund</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="switching-frequency-modulation-example">
<h2>Switching frequency modulation example<a class="headerlink" href="#switching-frequency-modulation-example" title="Permalink to this headline">¶</a></h2>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/dc_motor_drive_potmeter_control_three_button_bb.png"><img alt="../../_images/dc_motor_drive_potmeter_control_three_button_bb.png" src="../../_images/dc_motor_drive_potmeter_control_three_button_bb.png" style="width: 757.5px; height: 661.5px;" /></a>
</figure>
<p>The following source code listing is the complete software for the motor drive with switching frequency control:</p>
<div class="toggle docutils container">
<div class="header docutils container">
<p><strong>Show/Hide Code</strong></p>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Arduino.h&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;music.h&quot;</span>
<span class="cm">/*</span>
<span class="cm"> * The timer responsible for PWM generation on pin 5, and 6 is also used for the millis()</span>
<span class="cm"> * function. Thus it is not as accurate, and should be avoided if possible.</span>
<span class="cm"> * </span>
<span class="cm"> * Pins 5 and 6: controlled by Timer 0</span>
<span class="cm"> * Pins 9 and 10: controlled by timer 1 (16 bit timer)</span>
<span class="cm"> * Pins 11 and 3: controlled by timer 2</span>
<span class="cm"> */</span>
<span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">enable1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">input1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">9</span><span class="p">;</span>
<span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">input2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
<span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">enable_button</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12</span><span class="p">;</span>
<span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">direction_button</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">11</span><span class="p">;</span>
<span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">control_voltage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A0</span><span class="p">;</span>


<span class="cm">/*</span>
<span class="cm"> * Constants for the PWM switching frequency modulation routine.</span>
<span class="cm"> */</span>
<span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">beats_per_minute</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">96</span><span class="p">;</span>
<span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">note_gap_percent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>

<span class="k">const</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">beat_duration_us</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mf">60.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">beats_per_minute</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1000000L</span><span class="p">;</span>
<span class="k">const</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">note_gap_us</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">beat_duration_us</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">note_gap_percent</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">100.0</span><span class="p">);</span>

<span class="c1">//#define DEBUG</span>

<span class="k">typedef</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">FORWARD</span><span class="p">,</span>
<span class="w">  </span><span class="n">REVERSE</span>
<span class="p">}</span><span class="w"> </span><span class="n">direction_t</span><span class="p">;</span>

<span class="k">typedef</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">RUNNING</span><span class="p">,</span>
<span class="w">  </span><span class="n">BLOCKED</span><span class="p">,</span>
<span class="w">  </span><span class="n">STOPPED</span>
<span class="p">}</span><span class="w"> </span><span class="n">motor_state_t</span><span class="p">;</span>

<span class="k">typedef</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">PLAY_NOTE</span><span class="p">,</span>
<span class="w">  </span><span class="n">PAUSE_NOTE</span>
<span class="p">}</span><span class="w"> </span><span class="n">note_state_t</span><span class="p">;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">motor_control</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">duty_cycle</span><span class="p">,</span><span class="w"> </span><span class="n">direction_t</span><span class="w"> </span><span class="n">direction</span><span class="p">);</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">buttonPressed_debounce</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">digital_input</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">debounce_delay</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">set_pwm_output_10</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">duty_cycle</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">pwm_frequency</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">configure_timer_1</span><span class="p">();</span>
<span class="kt">uint16_t</span><span class="w"> </span><span class="nf">get_key_frequency</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">key_number</span><span class="p">);</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">run_motor_and_play_note</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">duty_cycle</span><span class="p">);</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">c_scale_test</span><span class="p">();</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">c_scale_test_2</span><span class="p">();</span>


<span class="kt">void</span><span class="w"> </span><span class="nf">setup</span><span class="p">(){</span>
<span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="n">enable1</span><span class="p">,</span><span class="w"> </span><span class="n">OUTPUT</span><span class="p">);</span>
<span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="n">input1</span><span class="p">,</span><span class="w"> </span><span class="n">OUTPUT</span><span class="p">);</span>
<span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="n">input2</span><span class="p">,</span><span class="w"> </span><span class="n">OUTPUT</span><span class="p">);</span>

<span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="n">enable_button</span><span class="p">,</span><span class="w"> </span><span class="n">INPUT</span><span class="p">);</span>
<span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="n">direction_button</span><span class="p">,</span><span class="w"> </span><span class="n">INPUT</span><span class="p">);</span>

<span class="w">  </span><span class="n">configure_timer_1</span><span class="p">();</span>

<span class="w">  </span><span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">loop</span><span class="p">(){</span>

<span class="w">  </span><span class="n">motor_state_t</span><span class="w"> </span><span class="n">motor_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">STOPPED</span><span class="p">;</span>
<span class="w">  </span><span class="n">direction_t</span><span class="w"> </span><span class="n">motor_direction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FORWARD</span><span class="p">;</span>
<span class="w">  </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">duty_cycle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">  </span><span class="k">for</span><span class="p">(;;){</span>

<span class="w">    </span><span class="n">duty_cycle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">analogRead</span><span class="p">(</span><span class="n">control_voltage</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span><span class="p">;</span>
<span class="w">   </span>
<span class="w">    </span><span class="cp">#ifdef DEBUG</span>
<span class="w">    </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;Duty cycle: &quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">duty_cycle</span><span class="p">);</span>
<span class="w">    </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
<span class="w">    </span><span class="cp">#endif</span>
<span class="w">    </span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * State machine for motor control.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">motor_state</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">RUNNING</span><span class="p">:</span>

<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">buttonPressed_debounce</span><span class="p">(</span><span class="n">enable_button</span><span class="p">,</span><span class="w"> </span><span class="mi">50</span><span class="p">)){</span>
<span class="w">        </span><span class="n">motor_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BLOCKED</span><span class="p">;</span>
<span class="w">        </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Motor blocked.&quot;</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">motor_direction</span><span class="p">)</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="no">FORWARD</span><span class="p">:</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">buttonPressed_debounce</span><span class="p">(</span><span class="n">direction_button</span><span class="p">,</span><span class="w"> </span><span class="mi">50</span><span class="p">)){</span>
<span class="w">          </span><span class="n">motor_direction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">REVERSE</span><span class="p">;</span>
<span class="w">          </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Motor direction reversed.&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">motor_control</span><span class="p">(</span><span class="n">duty_cycle</span><span class="p">,</span><span class="w"> </span><span class="n">FORWARD</span><span class="p">);</span>

<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="no">REVERSE</span><span class="p">:</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">buttonPressed_debounce</span><span class="p">(</span><span class="n">direction_button</span><span class="p">,</span><span class="w"> </span><span class="mi">50</span><span class="p">)){</span>
<span class="w">          </span><span class="n">motor_direction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FORWARD</span><span class="p">;</span>
<span class="w">          </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Motor direction forward.&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">motor_control</span><span class="p">(</span><span class="n">duty_cycle</span><span class="p">,</span><span class="w"> </span><span class="n">REVERSE</span><span class="p">);</span>

<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">      </span><span class="k">default</span><span class="o">:</span>
<span class="w">        </span><span class="n">motor_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">STOPPED</span><span class="p">;</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">BLOCKED</span><span class="p">:</span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">buttonPressed_debounce</span><span class="p">(</span><span class="n">enable_button</span><span class="p">,</span><span class="w"> </span><span class="mi">50</span><span class="p">)){</span>
<span class="w">        </span><span class="n">motor_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">STOPPED</span><span class="p">;</span>
<span class="w">        </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Motor stopped.&quot;</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="cm">/*</span>
<span class="cm">       * Rotor blocking is hard to implement without any measurements. We should at least measure</span>
<span class="cm">       * the armature current, and estimate (or measure) the rotor position.</span>
<span class="cm">       * </span>
<span class="cm">       * This kinda works, but it is far from ideal.</span>
<span class="cm">       */</span>
<span class="w">      </span><span class="n">_delay_us</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="w">      </span><span class="c1">//motor_control(100, FORWARD);</span>
<span class="w">      </span><span class="n">_delay_us</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="w">      </span><span class="c1">//motor_control(100, REVERSE);</span>

<span class="w">      </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">STOPPED</span><span class="p">:</span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">buttonPressed_debounce</span><span class="p">(</span><span class="n">enable_button</span><span class="p">,</span><span class="w"> </span><span class="mi">50</span><span class="p">)){</span>
<span class="w">        </span><span class="n">motor_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RUNNING</span><span class="p">;</span>
<span class="w">        </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Motor enabled.&quot;</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="n">motor_control</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">REVERSE</span><span class="p">);</span>

<span class="w">      </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">default</span><span class="o">:</span>
<span class="w">      </span><span class="n">motor_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">STOPPED</span><span class="p">;</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">motor_control</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">duty_cycle</span><span class="p">,</span><span class="w"> </span><span class="n">direction_t</span><span class="w"> </span><span class="n">direction</span><span class="p">){</span>

<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">direction</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">FORWARD</span><span class="p">){</span>
<span class="w">    </span><span class="n">digitalWrite</span><span class="p">(</span><span class="n">input1</span><span class="p">,</span><span class="w"> </span><span class="n">HIGH</span><span class="p">);</span>
<span class="w">    </span><span class="n">digitalWrite</span><span class="p">(</span><span class="n">input2</span><span class="p">,</span><span class="w"> </span><span class="n">LOW</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">digitalWrite</span><span class="p">(</span><span class="n">input1</span><span class="p">,</span><span class="w"> </span><span class="n">LOW</span><span class="p">);</span>
<span class="w">    </span><span class="n">digitalWrite</span><span class="p">(</span><span class="n">input2</span><span class="p">,</span><span class="w"> </span><span class="n">HIGH</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">run_motor_and_play_note</span><span class="p">(</span><span class="n">duty_cycle</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * TODO: If the motor is running backwards the music should also play backwards.</span>
<span class="cm"> */</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">run_motor_and_play_note</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">duty_cycle</span><span class="p">){</span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">start_micros</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">note_counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="n">note_state_t</span><span class="w"> </span><span class="n">note_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PLAY_NOTE</span><span class="p">;</span>

<span class="w">  </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">note_key_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">notes</span><span class="p">[</span><span class="n">note_counter</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
<span class="w">  </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">note_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">notes</span><span class="p">[</span><span class="n">note_counter</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>

<span class="w">  </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">note_duration_us</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">beat_duration_us</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mf">4.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">note_type</span><span class="p">);</span>
<span class="w">  </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">note_frequency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_key_frequency</span><span class="p">(</span><span class="n">note_key_number</span><span class="p">);</span>
<span class="w"> </span>
<span class="w">  </span><span class="k">switch</span><span class="p">(</span><span class="n">note_state</span><span class="p">){</span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="no">PLAY_NOTE</span><span class="p">:</span>

<span class="w">    </span><span class="n">set_pwm_output_10</span><span class="p">(</span><span class="n">duty_cycle</span><span class="p">,</span><span class="w"> </span><span class="n">note_frequency</span><span class="p">);</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">micros</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">start_micros</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">note_duration_us</span><span class="p">)){</span>
<span class="w">      </span><span class="n">note_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PAUSE_NOTE</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">break</span><span class="p">;</span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="no">PAUSE_NOTE</span><span class="p">:</span>

<span class="w">    </span><span class="n">set_pwm_output_10</span><span class="p">(</span><span class="n">duty_cycle</span><span class="p">,</span><span class="w"> </span><span class="mi">4000</span><span class="p">);</span><span class="w"> </span><span class="c1">// A high switching frequency is used for note gaps</span>
<span class="w">   </span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">micros</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">start_micros</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">note_duration_us</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">note_gap_us</span><span class="p">)){</span>
<span class="w">      </span><span class="n">start_micros</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">micros</span><span class="p">();</span>
<span class="w">      </span><span class="n">note_counter</span><span class="o">++</span><span class="p">;</span>
<span class="w">      </span><span class="n">note_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PLAY_NOTE</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">break</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// if(micros() &gt; (start_micros + note_duration_us)){</span>
<span class="w">  </span><span class="c1">//   uint16_t note_frequency = get_key_frequency(note_key_number);</span>
<span class="w">   </span>
<span class="w">  </span><span class="c1">//   start_micros = micros();</span>

<span class="w">  </span><span class="c1">//   set_pwm_output_10(duty_cycle, note_frequency);</span>

<span class="w">  </span><span class="c1">//   note_counter++;</span>
<span class="w">    </span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">note_counter</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">notes</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">notes</span><span class="p">))){</span>
<span class="w">    </span><span class="n">note_counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check if button is pressed, i.e. if it is high, and it was low before.</span>
<span class="cm"> * This version includes a debounce timer.</span>
<span class="cm"> * </span>
<span class="cm"> * The debounce time is stored as an array of 16 32-bit integers, thus it is</span>
<span class="cm"> * not very memory efficient. A better approach would be to use a object for</span>
<span class="cm"> * each button you wish to debounce.</span>
<span class="cm"> */</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">buttonPressed_debounce</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">digital_input</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">debounce_delay</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">lastStates</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">// Store the states of digital input 0 - 15.</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">lastEdgeDetect</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"> </span><span class="c1">// Store the time of the last rising edge.</span>
<span class="w">  </span>
<span class="w">  </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">digitalRead</span><span class="p">(</span><span class="n">digital_input</span><span class="p">);</span>


<span class="w">  </span><span class="c1">// Check if the state of the digital input has changed.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="p">((</span><span class="n">lastStates</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">digital_input</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">lastEdgeDetect</span><span class="p">[</span><span class="n">digital_input</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">millis</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">if</span><span class="p">((</span><span class="n">millis</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">lastEdgeDetect</span><span class="p">[</span><span class="n">digital_input</span><span class="p">])</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">debounce_delay</span><span class="p">){</span>

<span class="w">    </span><span class="n">lastStates</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">digital_input</span><span class="p">;</span><span class="w"> </span><span class="c1">// Store the current state of the digital input.</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">HIGH</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Sets the duty cycle and switching frequency for PWM output</span>
<span class="cm"> * on pin 10, i.e. timer 1.</span>
<span class="cm"> */</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">set_pwm_output_10</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">duty_cycle</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">pwm_frequency</span><span class="p">){</span>

<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">duty_cycle</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span>
<span class="w">    </span><span class="n">duty_cycle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
<span class="w">  </span>
<span class="w">  </span><span class="n">configure_timer_1</span><span class="p">();</span>

<span class="w">  </span><span class="n">TCCR1B</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">CS12</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">CS11</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">CS10</span><span class="p">);</span>

<span class="w">  </span><span class="cm">/*</span>
<span class="cm">   * The 16 bit OCR1A register is double buffered, which makes it safe to update while PWM is running.</span>
<span class="cm">   * </span>
<span class="cm">   * The required compare value for a given duty cycle depends on the PWM frequency.</span>
<span class="cm">   */</span>

<span class="w">  </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">top</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">F_CPU</span><span class="o">/</span><span class="p">((</span><span class="mi">1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pwm_frequency</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">  </span><span class="n">OCR1A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">top</span><span class="p">;</span>
<span class="w">  </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">comp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">top</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span><span class="o">*</span><span class="n">duty_cycle</span><span class="p">;</span>
<span class="w">  </span><span class="n">OCR1B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">comp</span><span class="p">;</span>

<span class="w">  </span><span class="cp">#ifdef DEBUG</span>
<span class="w">  </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;TOP: &quot;</span><span class="p">);</span>
<span class="w">  </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">top</span><span class="p">);</span>
<span class="w">  </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;COMP: &quot;</span><span class="p">);</span>
<span class="w">  </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">comp</span><span class="p">);</span>
<span class="w">  </span><span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
<span class="w">  </span><span class="cp">#endif</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">configure_timer_1</span><span class="p">(){</span>

<span class="w">  </span><span class="n">TCCR1A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">COM1A1</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">COM1A0</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">COM1B1</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">COM1B0</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">WGM11</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">WGM10</span><span class="p">);</span>
<span class="w">  </span>
<span class="w">  </span><span class="n">TCCR1B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">ICNC1</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">ICES1</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">WGM13</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">WGM12</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">CS12</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">CS11</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">CS10</span><span class="p">);</span>

<span class="w">  </span><span class="n">TCCR1C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">FOC1A</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">FOC1B</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">c_scale_test</span><span class="p">(){</span>

<span class="w">  </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">duty_cycle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span>
<span class="w">  </span><span class="n">set_pwm_output_10</span><span class="p">(</span><span class="n">duty_cycle</span><span class="p">,</span><span class="w"> </span><span class="mi">262</span><span class="p">);</span>
<span class="w">  </span><span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
<span class="w">  </span><span class="n">set_pwm_output_10</span><span class="p">(</span><span class="n">duty_cycle</span><span class="p">,</span><span class="w"> </span><span class="mi">294</span><span class="p">);</span>
<span class="w">  </span><span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
<span class="w">  </span><span class="n">set_pwm_output_10</span><span class="p">(</span><span class="n">duty_cycle</span><span class="p">,</span><span class="w"> </span><span class="mi">330</span><span class="p">);</span>
<span class="w">  </span><span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
<span class="w">  </span><span class="n">set_pwm_output_10</span><span class="p">(</span><span class="n">duty_cycle</span><span class="p">,</span><span class="w"> </span><span class="mi">349</span><span class="p">);</span>
<span class="w">  </span><span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
<span class="w">  </span><span class="n">set_pwm_output_10</span><span class="p">(</span><span class="n">duty_cycle</span><span class="p">,</span><span class="w"> </span><span class="mi">392</span><span class="p">);</span>
<span class="w">  </span><span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
<span class="w">  </span><span class="n">set_pwm_output_10</span><span class="p">(</span><span class="n">duty_cycle</span><span class="p">,</span><span class="w"> </span><span class="mi">440</span><span class="p">);</span>
<span class="w">  </span><span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
<span class="w">  </span><span class="n">set_pwm_output_10</span><span class="p">(</span><span class="n">duty_cycle</span><span class="p">,</span><span class="w"> </span><span class="mi">493</span><span class="p">);</span>
<span class="w">  </span><span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
<span class="w">  </span><span class="n">set_pwm_output_10</span><span class="p">(</span><span class="n">duty_cycle</span><span class="p">,</span><span class="w"> </span><span class="mi">523</span><span class="p">);</span>
<span class="w">  </span><span class="n">delay</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>

<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">c_scale_test_2</span><span class="p">(){</span>

<span class="w">  </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">duty_cycle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span>

<span class="w">  </span><span class="n">set_pwm_output_10</span><span class="p">(</span><span class="n">duty_cycle</span><span class="p">,</span><span class="w"> </span><span class="n">get_key_frequency</span><span class="p">(</span><span class="mi">40</span><span class="p">));</span>
<span class="w">  </span><span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
<span class="w">  </span><span class="n">set_pwm_output_10</span><span class="p">(</span><span class="n">duty_cycle</span><span class="p">,</span><span class="w"> </span><span class="n">get_key_frequency</span><span class="p">(</span><span class="mi">42</span><span class="p">));</span>
<span class="w">  </span><span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
<span class="w">  </span><span class="n">set_pwm_output_10</span><span class="p">(</span><span class="n">duty_cycle</span><span class="p">,</span><span class="w"> </span><span class="n">get_key_frequency</span><span class="p">(</span><span class="mi">44</span><span class="p">));</span>
<span class="w">  </span><span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
<span class="w">  </span><span class="n">set_pwm_output_10</span><span class="p">(</span><span class="n">duty_cycle</span><span class="p">,</span><span class="w"> </span><span class="n">get_key_frequency</span><span class="p">(</span><span class="mi">45</span><span class="p">));</span>
<span class="w">  </span><span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
<span class="w">  </span><span class="n">set_pwm_output_10</span><span class="p">(</span><span class="n">duty_cycle</span><span class="p">,</span><span class="w"> </span><span class="n">get_key_frequency</span><span class="p">(</span><span class="mi">47</span><span class="p">));</span>
<span class="w">  </span><span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
<span class="w">  </span><span class="n">set_pwm_output_10</span><span class="p">(</span><span class="n">duty_cycle</span><span class="p">,</span><span class="w"> </span><span class="n">get_key_frequency</span><span class="p">(</span><span class="mi">49</span><span class="p">));</span>
<span class="w">  </span><span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
<span class="w">  </span><span class="n">set_pwm_output_10</span><span class="p">(</span><span class="n">duty_cycle</span><span class="p">,</span><span class="w"> </span><span class="n">get_key_frequency</span><span class="p">(</span><span class="mi">51</span><span class="p">));</span>
<span class="w">  </span><span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
<span class="w">  </span><span class="n">set_pwm_output_10</span><span class="p">(</span><span class="n">duty_cycle</span><span class="p">,</span><span class="w"> </span><span class="n">get_key_frequency</span><span class="p">(</span><span class="mi">52</span><span class="p">));</span>
<span class="w">  </span><span class="n">delay</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>

<span class="p">}</span>

<span class="kt">uint16_t</span><span class="w"> </span><span class="nf">get_key_frequency</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">key_number</span><span class="p">){</span>

<span class="w">  </span><span class="k">if</span><span class="p">((</span><span class="n">key_number</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">key_number</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">88</span><span class="p">)){</span>
<span class="w">    </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">keyfreq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">pow</span><span class="p">(</span><span class="mf">2.0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">key_number</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">49.0</span><span class="p">)</span><span class="o">/</span><span class="mf">12.0</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">440.0</span><span class="p">);</span><span class="w"> </span><span class="c1">// Compute the frequency for a given piano key.</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">keyfreq</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</section>
<section id="arduino-math-functions">
<h2>Arduino math functions<a class="headerlink" href="#arduino-math-functions" title="Permalink to this headline">¶</a></h2>
<p>The Arduino library comes with several useful math functions. Some of these are almost self explanatory, while others may require some explaning. As always the best place to start looking for information about the Arduino built in functions is the <a class="reference external" href="https://www.arduino.cc/reference/en/">Arduino language reference</a></p>
<ul class="simple">
<li><p>abs()</p></li>
<li><p>constrain()</p></li>
<li><p>map()</p></li>
<li><p>max()</p></li>
<li><p>min()</p></li>
<li><p>pow()</p></li>
<li><p>sq()</p></li>
<li><p>sqrt()</p></li>
</ul>
<section id="trigonometry">
<h3>Trigonometry<a class="headerlink" href="#trigonometry" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>cos()</p></li>
<li><p>sin()</p></li>
<li><p>tan()</p></li>
</ul>
<p>If you need more advanced math functions the first library to check is <a class="reference external" href="http://www.nongnu.org/avr-libc/user-manual/group__avr__math.html">math.h</a></p>
</section>
</section>
<section id="simple-motor-drive-example-with-speed-control">
<h2>Simple motor drive example with speed control<a class="headerlink" href="#simple-motor-drive-example-with-speed-control" title="Permalink to this headline">¶</a></h2>
<p>The function <code class="code docutils literal notranslate"><span class="pre">analogWrite()</span></code> will be used to generate a PWM signal to the transistor, and the switching frequency will stay at it’s default value. A analog signal input on <cite>A0</cite> will be used to control the duty cycle of the PWM, and hence the torque (and consequently the speed) of the motor.</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/dc_motor_drive_single_transistor_speed_control_bb.png"><img alt="../../_images/dc_motor_drive_single_transistor_speed_control_bb.png" src="../../_images/dc_motor_drive_single_transistor_speed_control_bb.png" style="width: 784.5px; height: 661.5px;" /></a>
</figure>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Arduino.h&gt;</span>

<span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">pwm_pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">9</span><span class="p">;</span>
<span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">on_off_button</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12</span><span class="p">;</span>
<span class="kt">uint8_t</span><span class="w"> </span><span class="n">old_button_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="kt">uint8_t</span><span class="w"> </span><span class="n">motor_enable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">setup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="n">pwm_pin</span><span class="p">,</span><span class="w"> </span><span class="n">OUTPUT</span><span class="p">);</span>
<span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="n">on_off_button</span><span class="p">,</span><span class="w"> </span><span class="n">INPUT</span><span class="p">);</span>

<span class="w">  </span><span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">loop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">button_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">digitalRead</span><span class="p">(</span><span class="n">on_off_button</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">button_state</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">old_button_state</span><span class="p">){</span>

<span class="w">    </span><span class="n">old_button_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">button_state</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// TODO: This code requires debouncing of the push button.</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">button_state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">){</span>

<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">motor_enable</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">){</span>
<span class="w">        </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Motor disabled.&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">analogWrite</span><span class="p">(</span><span class="n">pwm_pin</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">        </span><span class="n">motor_enable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Motor enabled.&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">analogWrite</span><span class="p">(</span><span class="n">pwm_pin</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">);</span>
<span class="w">        </span><span class="n">motor_enable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w"> </span><span class="p">}</span>


<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">Footnotes</p>
<dl class="footnote brackets">
<dt class="label" id="f1"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>Source code as arduino.cc <a class="reference external" href="https://www.arduino.cc/en/Tutorial/DigitalReadSerial">DigitalReadSerial</a></p>
</dd>
</dl>
</section>
</section>


                </div>
              </div>
            </div>
          </div>
        </div>
        
        
      </div><!-- /row -->

      <!-- row -->
      <div class="row footer-relbar">
<div id="navbar-related" class=" related navbar navbar-default" role="navigation" aria-label="related navigation">
  <div class="navbar-inner">
    <ul class="nav navbar-nav ">
        <li><a href="../../index.html">ELE102 Microcontroller course v1.1.0 documentation</a></li>
    </ul>
<ul class="nav navbar-nav pull-right hidden-xs hidden-sm">
      
        <li><a href="../Lessons-additional/L13_additional.html" title="Additional material for lesson 13" >previous</a></li>
        <li><a href="../Projects/ir_communication.html" title="Infrared (IR) communication" >next</a></li>
        <li><a href="../../genindex.html" title="General Index" >index</a></li>
        <li><a href="#">top</a></li> 
      
    </ul>
  </div>
</div>
      </div><!-- /row -->

      <!-- footer -->
      <footer role="contentinfo">
          &copy; Copyright 2022, Gizem Ateş &amp; Eirik Haustveit.
        Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 4.5.0.
      </footer>
      <!-- /footer -->

    </div>
    <!-- /container -->

  </body>
</html>